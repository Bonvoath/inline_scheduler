<!doctype html>
<html>
<head>
    <meta charset="UTF-8">

	<title>Inline Scheduler</title>
    
		    
	<meta name="description" content="">
	<meta name="author" content="Mike Chaliy">
		    		    	
    <link rel="stylesheet" href="//twitter.github.com/bootstrap/1.3.0/bootstrap.min.css" />
	<link rel="stylesheet" href="css/style.css?v=2">
</head>
<body class="container">
        
    <h1>Inline Scheduler</h1>

    <div>
        <a id="refresh-stats-btn" class="btn primary">Refresh</a>
        <a id="stop-btn" class="btn">Stop</a>
        <a id="start-btn" class="btn">Start</a>
    </div>
    <div id="main"></div>    
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script src="//ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
	<script src="js/app.js"></script>	
    <script type="text/javascript">
        function formateToTime(inp) {
            // WTF need something to work with dates in javascript
            // From https://github.com/coolaj86/javascript-date/blob/master/date.js
            var pattern = /^(\d{4})(-(\d{2})(-(\d{2})(T(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2}))))?)?)?$/;
            var match = pattern.exec(inp);

            if (null === match) {
                return "N/A";
            }
            
            var hours = match[7] >> 0;
            var minutes = match[8] >> 0;
            var seconds = match[10] >> 0;                       
            
            return hours + ":" + minutes + ":" + seconds;
        }
        function currentTime() {
            var current = new Date();            
            return current.toLocaleTimeString();
        }
    </script>
    <script id="job-list-tmpl" type="text/x-jquery-tmpl">		
    {{if IsStopped}}    
    <strong>Stopped</strong>
    {{/if}}
    <p>
    Pending: ${PendingJobs}
    Scheduled: ${ScheduledJobs}
    Running: ${RunningJobs}    
    </p>        
    <em>Last generated at ${currentTime()}</em>
    <table class="zebra-striped">
    <thead>
        <tr>
            <th>Key</th>
            <th>Status</th>
            <th>Last Run</th>            
            <th>Report</th>            
            <th>&nbsp;</th>
        </tr>
    </thead>
    <tbody>        
    {{each CurrentJobs}}
        <tr>
            <td>
                ${$value.WorkKey}
                {{if $value.Description }}
                <br/>
                <em>${$value.Description}</em>
                {{/if}}
            </td>
            <td>${$value.CurrentStatus}</td>
            <td>${formateToTime($value.LastRunStarted)}-${formateToTime($value.LastRunCompleted)}</td>
            <td>{{tmpl($value) "#job-report-tmpl"}}</td>            
            <td><a class="force-work-btn btn primary" data-work-key="${$value.WorkKey}" >Force</a></td>
        </tr>
	{{/each}}
    </tbody>
    </table>
    </script>
    <script id="job-report-tmpl" type="text/x-jquery-tmpl">		     
    <dl>
    {{each PreviousRuns}}
        {{if $value.Result == "Failure" }}
        <dt><span class="label important">Important</span>${$value.Result}</dt>
        {{else}}
        <dt>${$value.Result}</dt>
        {{/if}}
        <dd>
            <em>${formateToTime($value.Started)}-${formateToTime($value.Completed)}</em>
            {{if $value.ResultMessage }}
            <pre style="max-width:350px">${$value.ResultMessage}</pre>
            {{/if}}
        </dd>        
	{{/each}}
    </dl>    
    </script>

</body>
</html>